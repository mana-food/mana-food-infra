name: Smoke Tests

on:
  workflow_call:
    inputs:
      gateway-url:
        required: true
        type: string

jobs:
  test:
    name: Health Checks
    runs-on: ubuntu-latest
    steps:
      - name: Wait
        run: sleep 30

      - name: Gateway Health
        run: curl -f ${{ inputs.gateway-url }}/healthz

      - name: Auth Endpoint
        run: |
          curl -f -X POST ${{ inputs.gateway-url }}/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"cpf":"00000000000","password":"test"}' || true

      - name: Protected Endpoint
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            ${{ inputs.gateway-url }}/api/users)
          [ "$STATUS" = "401" ] || [ "$STATUS" = "403" ]

      - name: Summary
        run: |
          echo "Gateway: ${{ inputs.gateway-url }}"
          echo "All smoke tests passed!"