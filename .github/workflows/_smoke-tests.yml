name: Smoke Tests

on:
  workflow_call:
    inputs:
      gateway-url:
        required: true
        type: string

jobs:
  test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for DNS propagation
        run: |
          echo "üîç Aguardando DNS do LoadBalancer propagar..."
          GATEWAY_URL="${{ inputs.gateway-url }}"
          
          # Remover http:// ou https:// se existir
          HOSTNAME=$(echo $GATEWAY_URL | sed 's|http://||' | sed 's|https://||' | sed 's|/.*||')
          
          echo "Hostname: $HOSTNAME"
          
          # Aguardar at√© 3 minutos (36 tentativas x 5 segundos)
          for i in {1..36}; do
            echo "Tentativa $i/36..."
            
            if nslookup $HOSTNAME > /dev/null 2>&1; then
              echo "‚úÖ DNS resolvido com sucesso!"
              sleep 10  # Aguardar mais 10s para estabilizar
              break
            fi
            
            if [ $i -eq 36 ]; then
              echo "‚ö†Ô∏è Timeout aguardando DNS, mas continuando testes..."
            fi
            
            sleep 5
          done

      - name: Gateway Health Check
        id: health
        continue-on-error: true
        run: |
          echo "üè• Testando health check do Gateway..."
          
          # Tentar 5 vezes com intervalo
          for i in {1..5}; do
            echo "Tentativa $i/5..."
            
            if curl -f -s -o /dev/null -w "%{http_code}" http://${{ inputs.gateway-url }}/healthz | grep -q "200"; then
              echo "‚úÖ Gateway health check passou!"
              exit 0
            fi
            
            if [ $i -lt 5 ]; then
              sleep 10
            fi
          done
          
          echo "‚ö†Ô∏è Gateway health check falhou ap√≥s 5 tentativas"
          exit 1

      - name: Test Lambda Auth Endpoint
        continue-on-error: true
        run: |
          echo "üîê Testando endpoint de autentica√ß√£o..."
          
          # Tentar login com credenciais inv√°lidas (deve retornar 401)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://${{ inputs.gateway-url }}/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"cpf":"00000000000","password":"invalid"}')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "400" ] || [ "$HTTP_CODE" = "404" ]; then
            echo "‚úÖ Auth endpoint est√° respondendo corretamente (esperado 4xx)"
          else
            echo "‚ö†Ô∏è Auth endpoint retornou c√≥digo inesperado: $HTTP_CODE"
          fi

      - name: Test Protected Endpoint (Unauthorized)
        continue-on-error: true
        run: |
          echo "üîí Testando endpoint protegido sem autentica√ß√£o..."
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            http://${{ inputs.gateway-url }}/api/users)
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "403" ]; then
            echo "‚úÖ Endpoint protegido bloqueando acesso n√£o autenticado (esperado 401/403)"
          else
            echo "‚ö†Ô∏è Endpoint protegido retornou c√≥digo inesperado: $HTTP_CODE"
          fi

      - name: Test Metrics/Health Endpoints
        continue-on-error: true
        run: |
          echo "üìä Testando endpoints de monitoramento..."
          
          # Testar /healthz
          if curl -f -s http://${{ inputs.gateway-url }}/healthz > /dev/null 2>&1; then
            echo "‚úÖ /healthz OK"
          else
            echo "‚ö†Ô∏è /healthz falhou"
          fi
          
          # Testar /ready se existir
          if curl -f -s http://${{ inputs.gateway-url }}/ready > /dev/null 2>&1; then
            echo "‚úÖ /ready OK"
          else
            echo "‚ÑπÔ∏è /ready n√£o dispon√≠vel ou falhou"
          fi

      - name: Summary Report
        if: always()
        run: |
          echo "======================================"
          echo "üìã SMOKE TESTS SUMMARY"
          echo "======================================"
          echo "Gateway URL: http://${{ inputs.gateway-url }}"
          echo "Health Check: ${{ steps.health.outcome }}"
          echo ""
          echo "‚úÖ Deploy conclu√≠do com sucesso!"
          echo "üåê Acesse: http://${{ inputs.gateway-url }}"
          echo ""
          echo "Comandos √∫teis:"
          echo "  kubectl get pods"
          echo "  kubectl get svc"
          echo "  kubectl logs -l app=api-gateway"
          echo "  kubectl logs -l app=user-service"