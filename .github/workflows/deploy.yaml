name: Deploy ManaFood Microservices

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        type: choice
        options: [dev, prod]
        default: 'dev'
      deploy-lambda:
        description: 'Deploy Lambda Auth'
        type: boolean
        default: true
      deploy-gateway:
        description: 'Deploy API Gateway'
        type: boolean
        default: true
      deploy-user-service:
        description: 'Deploy User Service'
        type: boolean
        default: true
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # ==========================================
  # STAGE 1: BUILD
  # ==========================================
  build:
    name: Build All Services
    uses: ./.github/workflows/_build.yml
    secrets: inherit

  # ==========================================
  # STAGE 2: INFRASTRUCTURE
  # ==========================================
  infra:
    name: Deploy Infrastructure
    needs: build
    uses: ./.github/workflows/_terraform.yml
    secrets: inherit
    with:
      action: apply

  # ==========================================
  # STAGE 3: DEPLOY LAMBDA (Conditional)
  # ==========================================
  deploy-lambda:
    name: Deploy Lambda Auth
    needs: [build, infra]
    if: github.event.inputs.deploy-lambda != 'false'
    uses: ./.github/workflows/_deploy-lambda.yml
    secrets: inherit
    with:
      lambda-artifact: ${{ needs.build.outputs.lambda-artifact }}
      lambda-function: ${{ needs.infra.outputs.lambda-function }}

  # ==========================================
  # STAGE 4: DEPLOY GATEWAY (Conditional)
  # Depende do Lambda estar atualizado
  # ==========================================
  deploy-gateway:
    name: Deploy API Gateway
    needs: [build, infra, deploy-lambda]
    if: |
      always() && 
      github.event.inputs.deploy-gateway != 'false' &&
      (needs.deploy-lambda.result == 'success' || needs.deploy-lambda.result == 'skipped')
    uses: ./.github/workflows/_deploy-gateway.yml
    secrets: inherit
    with:
      gateway-image: ${{ needs.build.outputs.gateway-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      lambda-url: ${{ needs.infra.outputs.lambda-url }}

  # ==========================================
  # STAGE 5: DEPLOY USER SERVICE (Conditional)
  # Pode rodar em paralelo com Gateway
  # ==========================================
  deploy-user-service:
    name: Deploy User Service
    needs: [build, infra]
    if: github.event.inputs.deploy-user-service != 'false'
    uses: ./.github/workflows/_deploy-user-service.yml
    secrets: inherit
    with:
      user-service-image: ${{ needs.build.outputs.user-service-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      user-service-role: ${{ needs.infra.outputs.user-service-role }}

  # ==========================================
  # STAGE 6: SMOKE TESTS
  # ==========================================
  test:
    name: Smoke Tests
    needs: [deploy-gateway]
    if: |
      always() &&
      github.event.inputs.deploy-gateway != 'false' && 
      needs.deploy-gateway.result == 'success' &&
      needs.deploy-gateway.outputs.gateway-url != 'http://pending'
    uses: ./.github/workflows/_smoke-tests.yml
    secrets: inherit
    with:
      gateway-url: ${{ needs.deploy-gateway.outputs.gateway-url }}

  # ==========================================
  # ROLLBACK
  # ==========================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [build, infra, deploy-lambda, deploy-gateway, deploy-user-service, test]
    if: failure()
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup kubectl
        if: needs.infra.result == 'success'
        run: |
          aws eks update-kubeconfig --region us-east-1 --name $(echo "${{ needs.infra.outputs.eks-cluster }}" || echo "mana-food-eks") || true

      - name: Delete K8s Resources
        if: needs.deploy-gateway.result == 'failure' || needs.deploy-user-service.result == 'failure' || needs.test.result == 'failure'
        continue-on-error: true
        run: |
          kubectl delete deployment --all -n default || true
          kubectl delete service --all -n default || true
          kubectl delete configmap --all -n default || true
          kubectl delete secret --all -n default || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Destroy
        if: needs.infra.result == 'success'
        continue-on-error: true
        working-directory: terraform/envs/prod
        run: |
          terraform init
          terraform destroy \
            -var="jwt_secret_key=${{ secrets.JWT_SECRET }}" \
            -var="bucket_state_name=${{ secrets.TF_STATE_BUCKET }}" \
            -auto-approve

      - name: Cleanup ECR Images
        continue-on-error: true
        run: |
          aws ecr batch-delete-image \
            --repository-name mana-food-gateway \
            --image-ids imageTag=${{ github.sha }} || true
          
          aws ecr batch-delete-image \
            --repository-name mana-food-user-service \
            --image-ids imageTag=${{ github.sha }} || true

      - name: Rollback Summary
        run: |
          echo "⚠️ ROLLBACK EXECUTADO"
          echo "Falha detectada em:"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Infra: ${{ needs.infra.result }}"
          echo "  - Lambda: ${{ needs.deploy-lambda.result }}"
          echo "  - Gateway: ${{ needs.deploy-gateway.result }}"
          echo "  - User Service: ${{ needs.deploy-user-service.result }}"
          echo "  - Tests: ${{ needs.test.result }}"