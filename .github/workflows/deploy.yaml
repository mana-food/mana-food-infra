name: Deploy ManaFood Microservices

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        type: choice
        options: [dev, prod]
        default: 'dev'
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  # ==========================================
  # STAGE 1: BUILD (Parallel)
  # ==========================================
  build:
    name: Build All Services
    uses: ./.github/workflows/_build.yml
    secrets: inherit

  # ==========================================
  # STAGE 2: INFRASTRUCTURE
  # ==========================================
  infra:
    name: Deploy Infrastructure
    needs: build
    uses: ./.github/workflows/_terraform.yml
    secrets: inherit
    with:
      action: apply

  # ==========================================
  # STAGE 3: DEPLOY SERVICES
  # ==========================================
  deploy:
    name: Deploy Services
    needs: [build, infra]
    uses: ./.github/workflows/_deploy-services.yml
    secrets: inherit
    with:
      lambda-artifact: ${{ needs.build.outputs.lambda-artifact }}
      gateway-image: ${{ needs.build.outputs.gateway-image }}
      user-service-image: ${{ needs.build.outputs.user-service-image }}
      lambda-function: ${{ needs.infra.outputs.lambda-function }}
      lambda-url: ${{ needs.infra.outputs.lambda-url }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      dynamodb-table: ${{ needs.infra.outputs.dynamodb-table }}
      user-service-role: ${{ needs.infra.outputs.user-service-role }}

  # ==========================================
  # STAGE 4: SMOKE TESTS
  # ==========================================
  test:
    name: Smoke Tests
    needs: deploy
    uses: ./.github/workflows/_smoke-tests.yml
    secrets: inherit
    with:
      gateway-url: ${{ needs.deploy.outputs.gateway-url }}

  # ==========================================
  # ROLLBACK AUTOM√ÅTICO EM CASO DE FALHA
  # ==========================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [build, infra, deploy, test]
    if: failure()
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup kubectl
        if: needs.infra.result == 'success'
        run: |
          aws eks update-kubeconfig --region us-east-1 --name $(echo "${{ needs.infra.outputs.eks-cluster }}" || echo "mana-food-eks") || true

      - name: Delete K8s Resources
        if: needs.deploy.result == 'failure' || needs.test.result == 'failure'
        continue-on-error: true
        run: |
          kubectl delete deployment --all -n default || true
          kubectl delete service --all -n default || true
          kubectl delete configmap --all -n default || true
          kubectl delete secret --all -n default || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Destroy
        if: needs.infra.result == 'success'
        continue-on-error: true
        working-directory: infra/terraform/envs/prod
        run: |
          terraform init
          terraform destroy \
            -var="jwt_secret_key=${{ secrets.JWT_SECRET }}" \
            -var="bucket_state_name=${{ secrets.TF_STATE_BUCKET }}" \
            -auto-approve

      - name: Cleanup ECR Images
        continue-on-error: true
        run: |
          aws ecr batch-delete-image \
            --repository-name mana-food-gateway \
            --image-ids imageTag=${{ github.sha }} || true
          
          aws ecr batch-delete-image \
            --repository-name mana-food-user-service \
            --image-ids imageTag=${{ github.sha }} || true

      - name: Send Rollback Notification
        run: |
          echo "ROLLBACK EXECUTADO"
          echo "Falha detectada em:"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Infra: ${{ needs.infra.result }}"
          echo "  - Deploy: ${{ needs.deploy.result }}"
          echo "  - Test: ${{ needs.test.result }}"