name: Deploy ManaFood Microservices

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        type: choice
        options: [dev, prod]
        default: 'dev'
      force-rebuild-all:
        description: 'Force rebuild all services'
        type: boolean
        default: false
      deploy-lambda:
        description: 'Deploy Lambda Auth'
        type: boolean
        default: true
      deploy-gateway:
        description: 'Deploy API Gateway'
        type: boolean
        default: true
      deploy-user-service:
        description: 'Deploy User Service'
        type: boolean
        default: true
      deploy-order-service:
        description: 'Deploy Order Service'
        type: boolean
        default: true
      deploy-product-service:
        description: 'Deploy Product Service'
        type: boolean
        default: true
      deploy-payment-service:
        description: 'Deploy Payment Service'
        type: boolean
        default: true
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  build:
    name: Build All Services
    uses: ./.github/workflows/_build.yml
    with:
      force-build-gateway: ${{ github.event.inputs.force-rebuild-all == 'true' }}
      force-build-user-service: ${{ github.event.inputs.force-rebuild-all == 'true' }}
      force-build-order-service: ${{ github.event.inputs.force-rebuild-all == 'true' }}
      force-build-product-service: ${{ github.event.inputs.force-rebuild-all == 'true' }}
      force-build-payment-service: ${{ github.event.inputs.force-rebuild-all == 'true' }}
      force-build-lambda: ${{ github.event.inputs.force-rebuild-all == 'true' }}
    secrets: inherit

  # ==========================================
  # STAGE 2: INFRASTRUCTURE
  # ==========================================
  infra:
    name: Deploy Infrastructure
    needs: build
    uses: ./.github/workflows/_terraform.yml
    secrets: inherit
    with:
      action: apply

  # ==========================================
  # STAGE 3: DEPLOY LAMBDA (Conditional)
  # ==========================================
  deploy-lambda:
    name: Deploy Lambda Auth
    needs: [build, infra]
    if: github.event.inputs.deploy-lambda != 'false'
    uses: ./.github/workflows/_deploy-lambda.yml
    secrets: inherit
    with:
      lambda-artifact: ${{ needs.build.outputs.lambda-artifact }}
      lambda-function: ${{ needs.infra.outputs.lambda-function }}

  # ==========================================
  # STAGE 4: DEPLOY GATEWAY (Conditional)
  # Depende do Lambda estar atualizado
  # ==========================================
  deploy-gateway:
    name: Deploy API Gateway
    needs: [build, infra, deploy-lambda]
    if: |
      always() && 
      github.event.inputs.deploy-gateway != 'false' &&
      (needs.deploy-lambda.result == 'success' || needs.deploy-lambda.result == 'skipped')
    uses: ./.github/workflows/_deploy-gateway.yml
    secrets: inherit
    with:
      gateway-image: ${{ needs.build.outputs.gateway-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      lambda-url: ${{ needs.infra.outputs.lambda-url }}

  # ==========================================
  # STAGE 5: DEPLOY USER SERVICE (Conditional)
  # ==========================================
  deploy-user-service:
    name: Deploy User Service
    needs: [build, infra]
    if: github.event.inputs.deploy-user-service != 'false'
    uses: ./.github/workflows/_deploy-user-service.yml
    secrets: inherit
    with:
      user-service-image: ${{ needs.build.outputs.user-service-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      user-service-role: ${{ needs.infra.outputs.user-service-role }}

  # ==========================================
  # STAGE 6: DEPLOY ORDER SERVICE (Conditional)
  # ==========================================
  deploy-order-service:
    name: Deploy Order Service
    needs: [build, infra]
    if: github.event.inputs.deploy-order-service != 'false'
    uses: ./.github/workflows/_deploy-order-service.yml
    secrets: inherit
    with:
      order-service-image: ${{ needs.build.outputs.order-service-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      order-service-role: ${{ needs.infra.outputs.order-service-role }}
      orders-db-endpoint: ${{ needs.infra.outputs.orders-db-endpoint }}
      orders-db-secret-arn: ${{ needs.infra.outputs.orders-db-secret-arn }}

  # ==========================================
  # STAGE 7: DEPLOY PRODUCT SERVICE (Conditional)
  # ==========================================
  deploy-product-service:
    name: Deploy Product Service
    needs: [build, infra]
    if: github.event.inputs.deploy-product-service != 'false'
    uses: ./.github/workflows/_deploy-product-service.yml
    secrets: inherit
    with:
      product-service-image: ${{ needs.build.outputs.product-service-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}
      product-service-role: ${{ needs.infra.outputs.product-service-role }}
      products-db-endpoint: ${{ needs.infra.outputs.products-db-endpoint }}
      products-db-secret-arn: ${{ needs.infra.outputs.products-db-secret-arn }}

  # ==========================================
  # STAGE 8: DEPLOY PAYMENT SERVICE (Conditional)
  # ==========================================
  deploy-payment-service:
    name: Deploy Payment Service
    needs: [build, infra]
    if: github.event.inputs.deploy-payment-service != 'false'
    uses: ./.github/workflows/_deploy-payment-service.yml
    secrets: inherit
    with:
      payment-service-image: ${{ needs.build.outputs.payment-service-image }}
      eks-cluster: ${{ needs.infra.outputs.eks-cluster }}

  # ==========================================
  # STAGE 9: SMOKE TESTS
  # ==========================================
  test:
    name: Smoke Tests
    needs: [deploy-gateway]
    if: |
      always() &&
      github.event.inputs.deploy-gateway != 'false' && 
      needs.deploy-gateway.result == 'success' &&
      needs.deploy-gateway.outputs.gateway-url != 'http://pending'
    uses: ./.github/workflows/_smoke-tests.yml
    secrets: inherit
    with:
      gateway-url: ${{ needs.deploy-gateway.outputs.gateway-url }}

  # ==========================================
  # ROLLBACK
  # ==========================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [build, infra, deploy-lambda, deploy-gateway, deploy-user-service, deploy-order-service, deploy-product-service, deploy-payment-service, test]
    if: failure()
    
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup kubectl
        if: needs.infra.result == 'success'
        run: |
          aws eks update-kubeconfig --region us-east-1 --name $(echo "${{ needs.infra.outputs.eks-cluster }}" || echo "mana-food-eks") || true

      # Rollback seletivo - s√≥ apaga o que falhou
      - name: Rollback Gateway
        if: needs.deploy-gateway.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo Gateway..."
          kubectl delete deployment api-gateway -n default || true
          kubectl delete service api-gateway -n default || true
          kubectl delete hpa api-gateway-hpa -n default || true

      - name: Rollback User Service
        if: needs.deploy-user-service.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo User Service..."
          kubectl delete deployment user-service -n default || true
          kubectl delete service user-service -n default || true
          kubectl delete serviceaccount user-service-sa -n default || true
          kubectl delete hpa user-service-hpa -n default || true

      - name: Rollback Order Service
        if: needs.deploy-order-service.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo Order Service..."
          kubectl delete deployment order-service -n default || true
          kubectl delete service order-service -n default || true
          kubectl delete serviceaccount order-service-sa -n default || true
          kubectl delete secret order-db-secret -n default || true
          kubectl delete hpa order-service-hpa -n default || true

      - name: Rollback Product Service
        if: needs.deploy-product-service.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo Product Service..."
          kubectl delete deployment product-service -n default || true
          kubectl delete service product-service -n default || true
          kubectl delete serviceaccount product-service-sa -n default || true
          kubectl delete secret product-db-secret -n default || true
          kubectl delete hpa product-service-hpa -n default || true

      - name: Rollback Payment Service
        if: needs.deploy-payment-service.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo Payment Service..."
          kubectl delete deployment payment-service -n default || true
          kubectl delete service payment-service -n default || true
          kubectl delete hpa payment-service-hpa -n default || true

      - name: Rollback Lambda
        if: needs.deploy-lambda.result == 'failure'
        continue-on-error: true
        run: |
          echo "üîÑ Revertendo Lambda..."
          # Lambda n√£o precisa de rollback, pr√≥ximo deploy sobrescreve

      - name: Cleanup ECR Images (apenas dos servi√ßos que falharam)
        continue-on-error: true
        run: |
          # Gateway
          if [ "${{ needs.deploy-gateway.result }}" = "failure" ]; then
            aws ecr batch-delete-image \
              --repository-name mana-food-gateway \
              --image-ids imageTag=${{ github.sha }} || true
          fi
          
          # User Service
          if [ "${{ needs.deploy-user-service.result }}" = "failure" ]; then
            aws ecr batch-delete-image \
              --repository-name mana-food-user-service \
              --image-ids imageTag=${{ github.sha }} || true
          fi
          
          # Order Service
          if [ "${{ needs.deploy-order-service.result }}" = "failure" ]; then
            aws ecr batch-delete-image \
              --repository-name mana-food-order-service \
              --image-ids imageTag=${{ github.sha }} || true
          fi
          
          # Product Service
          if [ "${{ needs.deploy-product-service.result }}" = "failure" ]; then
            aws ecr batch-delete-image \
              --repository-name mana-food-product-service \
              --image-ids imageTag=${{ github.sha }} || true
          fi
          
          # Payment Service
          if [ "${{ needs.deploy-payment-service.result }}" = "failure" ]; then
            aws ecr batch-delete-image \
              --repository-name mana-food-payment-service \
              --image-ids imageTag=${{ github.sha }} || true
          fi

      - name: Rollback Summary
        run: |
          echo "‚ö†Ô∏è ROLLBACK SELETIVO EXECUTADO"
          echo ""
          echo "Status dos componentes:"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Infra: ${{ needs.infra.result }}"
          echo "  - Lambda: ${{ needs.deploy-lambda.result }}"
          echo "  - Gateway: ${{ needs.deploy-gateway.result }}"
          echo "  - User Service: ${{ needs.deploy-user-service.result }}"
          echo "  - Order Service: ${{ needs.deploy-order-service.result }}"
          echo "  - Product Service: ${{ needs.deploy-product-service.result }}"
          echo "  - Payment Service: ${{ needs.deploy-payment-service.result }}"
          echo "  - Tests: ${{ needs.test.result }}"
          echo ""
          echo "‚úÖ Servi√ßos bem-sucedidos foram mantidos"
          echo "‚ùå Apenas os servi√ßos com falha foram revertidos"