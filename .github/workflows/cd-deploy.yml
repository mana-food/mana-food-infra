name: Deploy na AWS

on:
  workflow_dispatch:   # Gatilho manual ou via outro repositório
    inputs:
      image:
        description: "Imagem da aplicação para deploy"
        required: true
        default: "apply"
        type: string

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init

      - name: Terraform ${{ github.event.inputs.action }}
        run: terraform ${{ github.event.inputs.action }} -auto-approve

  deploy:
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - uses: actions/checkout@v4

      - name: Apply Kubernetes manifests
        run: |
          echo "Fazendo deploy da imagem ${{ github.event.inputs.image }}"
          kubectl set image deployment/my-app my-app=${{ github.event.inputs.image }}
          kubectl rollout status deployment/my-app
